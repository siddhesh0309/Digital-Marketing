import pandas as pd
import os

# File paths
payact_file = "path/to/payact.xlsx"  # Update with the correct path
gl_file = "path/to/gl.xlsx"          # Update with the correct path
master_file = "path/to/master.xlsx"  # Update with the desired master file path

# Load input files
payact_df = pd.read_excel(payact_file)
gl_df = pd.read_excel(gl_file)

# Check if master file exists
if not os.path.exists(master_file):
    # Create the master file for the first time
    with pd.ExcelWriter(master_file, engine="openpyxl") as writer:
        # Write payact data
        payact_df.to_excel(writer, sheet_name="payact", index=False)
        
        # Filter and write Daily Consolidate data
        filtered_gl = gl_df[(gl_df['Type'] == 'res') & (gl_df['Terminal'] == 'z@td')]
        filtered_gl.to_excel(writer, sheet_name="Daily Consolidate", index=False)

        # Create and write Red Pivot data
        if 'Account' in filtered_gl.columns and 'Amount' in filtered_gl.columns:
            red_pivot = filtered_gl.groupby('Account', as_index=False)['Amount'].sum()
            red_pivot = red_pivot.rename(columns={'Amount': 'Sum'})
        else:
            red_pivot = pd.DataFrame()
        red_pivot.to_excel(writer, sheet_name="Red Pivot", index=False)

    print("Master file created for the first time.")
else:
    # Load existing sheets from master file
    try:
        existing_payact = pd.read_excel(master_file, sheet_name="payact")
    except ValueError:
        existing_payact = pd.DataFrame()

    try:
        existing_daily_consolidate = pd.read_excel(master_file, sheet_name="Daily Consolidate")
    except ValueError:
        existing_daily_consolidate = pd.DataFrame()

    # Append new data to the existing sheets
    updated_payact = pd.concat([existing_payact, payact_df], ignore_index=True)
    filtered_gl = gl_df[(gl_df['Type'] == 'res') & (gl_df['Terminal'] == 'z@td')]
    updated_daily_consolidate = pd.concat([existing_daily_consolidate, filtered_gl], ignore_index=True)

    # Calculate Red Pivot by grouping the updated Daily Consolidate data
    if 'Account' in updated_daily_consolidate.columns and 'Amount' in updated_daily_consolidate.columns:
        red_pivot = updated_daily_consolidate.groupby('Account', as_index=False)['Amount'].sum()
        red_pivot = red_pivot.rename(columns={'Amount': 'Sum'})
    else:
        red_pivot = pd.DataFrame()

    # Save updated data back to the master file
    with pd.ExcelWriter(master_file, engine="openpyxl", mode="a", if_sheet_exists="replace") as writer:
        updated_payact.to_excel(writer, sheet_name="payact", index=False)
        updated_daily_consolidate.to_excel(writer, sheet_name="Daily Consolidate", index=False)
        red_pivot.to_excel(writer, sheet_name="Red Pivot", index=False)

    print("Master file updated with appended data and recalculated sums.")
